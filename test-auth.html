<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯æœºåˆ¶æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #66b1ff;
        }
        .result {
            background: #f0f9ff;
            border: 1px solid #bee3f8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .error {
            background: #fef2f2;
            border-color: #fecaca;
        }
        .success {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è®¤è¯æœºåˆ¶æµ‹è¯•</h1>
    
    <div class="container">
        <h2>æ¼”ç¤ºè´¦æˆ·ä¿¡æ¯</h2>
        <p><strong>ç®¡ç†å‘˜:</strong> admin / operator / viewer (å¯†ç : demo123)</p>
        <p><strong>æµ‹è¯•ç”¨æˆ·:</strong> test / user (å¯†ç : 123456)</p>
    </div>

    <div class="container">
        <h2>1. æµ‹è¯•ç™»å½•æµç¨‹</h2>
        <button onclick="testLogin('admin', 'demo123')">ç™»å½•ç®¡ç†å‘˜</button>
        <button onclick="testLogin('test', '123456')">ç™»å½•æµ‹è¯•ç”¨æˆ·</button>
        <button onclick="testLogout()">ç™»å‡º</button>
        <div id="loginResult" class="result" style="display:none;"></div>
    </div>

    <div class="container">
        <h2>2. æµ‹è¯•é¡µé¢è®¿é—®æƒé™</h2>
        <button onclick="testDeviceMonitor()">è®¿é—®è®¾å¤‡ç›‘æ§é¡µé¢</button>
        <button onclick="testDashboard()">è®¿é—®ä»ªè¡¨æ¿é¡µé¢</button>
        <button onclick="testErrorLogs()">è®¿é—®é”™è¯¯æ—¥å¿—é¡µé¢</button>
        <div id="accessResult" class="result" style="display:none;"></div>
    </div>

    <div class="container">
        <h2>3. æ£€æŸ¥è®¤è¯çŠ¶æ€</h2>
        <button onclick="checkAuthStatus()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
        <div id="statusResult" class="result" style="display:none;"></div>
    </div>

    <div class="container">
        <h2>4. è®¤è¯æµç¨‹æµ‹è¯•</h2>
        <button onclick="testFullFlow()">å®Œæ•´æµç¨‹æµ‹è¯•</button>
        <div id="flowResult" class="result" style="display:none;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';

        async function testLogin(username, password) {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… ç™»å½•æˆåŠŸ!\nç”¨æˆ·: ${data.user?.username}\nè§’è‰²: ${data.user?.role}\nToken: ${data.token?.substring(0, 20)}...`;
                    
                    // ä¿å­˜tokenåˆ°localStorage
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ ç™»å½•å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
            }
        }

        async function testLogout() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result success';
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            resultDiv.textContent = 'âœ… å·²ç™»å‡ºï¼Œæœ¬åœ°æ•°æ®å·²æ¸…é™¤';
        }

        async function testDeviceMonitor() {
            const resultDiv = document.getElementById('accessResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_BASE}/device-monitor`, {
                    headers: token ? {
                        'Authorization': `Bearer ${token}`
                    } : {}
                });

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'âœ… æˆåŠŸè®¿é—®è®¾å¤‡ç›‘æ§é¡µé¢';
                } else if (response.status === 401) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'âŒ æœªè®¤è¯ï¼Œè¢«é‡å®šå‘åˆ°ç™»å½•é¡µé¢';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
            }
        }

        async function testDashboard() {
            const resultDiv = document.getElementById('accessResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            try {
                const response = await fetch(`${API_BASE}/`);
                resultDiv.className = 'result success';
                resultDiv.textContent = 'âœ… æˆåŠŸè®¿é—®é¦–é¡µ/ä»ªè¡¨æ¿é¡µé¢';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
            }
        }

        async function testErrorLogs() {
            const resultDiv = document.getElementById('accessResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_BASE}/error-logs`, {
                    headers: token ? {
                        'Authorization': `Bearer ${token}`
                    } : {}
                });

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'âœ… æˆåŠŸè®¿é—®é”™è¯¯æ—¥å¿—é¡µé¢';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
            }
        }

        async function checkAuthStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'âŒ æœªç™»å½•ï¼Œæ²¡æœ‰token';
                return;
            }
            
            try {
                // å°è¯•è°ƒç”¨è®¤è¯çŠ¶æ€API
                const response = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… å·²è®¤è¯\næœ¬åœ°ç”¨æˆ·: ${user ? JSON.parse(user).username : 'N/A'}\nAPIç”¨æˆ·: ${userData.username || 'N/A'}\nTokenå­˜åœ¨: æ˜¯`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `âŒ Tokenæ— æ•ˆï¼ŒçŠ¶æ€ç : ${response.status}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`;
            }
        }

        async function testFullFlow() {
            const resultDiv = document.getElementById('flowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            let log = 'ğŸ”„ å¼€å§‹å®Œæ•´è®¤è¯æµç¨‹æµ‹è¯•...\n\n';
            
            try {
                // 1. æ£€æŸ¥åˆå§‹çŠ¶æ€
                log += '1ï¸âƒ£ æ£€æŸ¥åˆå§‹çŠ¶æ€...\n';
                const initialToken = localStorage.getItem('token');
                if (initialToken) {
                    log += '   å‘ç°å·²å­˜åœ¨çš„tokenï¼Œæ¸…é™¤åé‡æ–°å¼€å§‹\n';
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                }
                log += '   âœ… åˆå§‹çŠ¶æ€: æœªç™»å½•\n\n';
                
                // 2. å°è¯•è®¿é—®å—ä¿æŠ¤é¡µé¢
                log += '2ï¸âƒ£ æµ‹è¯•æœªè®¤è¯è®¿é—®è®¾å¤‡ç›‘æ§é¡µé¢...\n';
                await testDeviceMonitor();
                log += '   âœ… åº”è¯¥è¢«é‡å®šå‘åˆ°ç™»å½•é¡µé¢\n\n';
                
                // 3. æ‰§è¡Œç™»å½•
                log += '3ï¸âƒ£ æ‰§è¡Œç™»å½•æ“ä½œ...\n';
                const loginResponse = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: 'admin', password: 'demo123' })
                });
                
                const loginData = await loginResponse.json();
                if (loginResponse.ok) {
                    localStorage.setItem('token', loginData.token);
                    localStorage.setItem('user', JSON.stringify(loginData.user));
                    log += `   âœ… ç™»å½•æˆåŠŸ: ${loginData.user.username}\n\n`;
                } else {
                    log += `   âŒ ç™»å½•å¤±è´¥: ${loginData.message}\n\n`;
                    resultDiv.textContent = log;
                    return;
                }
                
                // 4. å†æ¬¡è®¿é—®å—ä¿æŠ¤é¡µé¢
                log += '4ï¸âƒ£ æµ‹è¯•å·²è®¤è¯è®¿é—®è®¾å¤‡ç›‘æ§é¡µé¢...\n';
                log += '   âœ… åº”è¯¥æˆåŠŸè®¿é—®\n\n';
                
                // 5. æ£€æŸ¥è®¤è¯çŠ¶æ€
                log += '5ï¸âƒ£ æ£€æŸ¥è®¤è¯çŠ¶æ€...\n';
                const statusResponse = await fetch(`${API_BASE}/api/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (statusResponse.ok) {
                    log += '   âœ… è®¤è¯çŠ¶æ€æœ‰æ•ˆ\n\n';
                } else {
                    log += `   âŒ è®¤è¯çŠ¶æ€æ— æ•ˆ: ${statusResponse.status}\n\n`;
                }
                
                log += 'ğŸ‰ å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ!';
                resultDiv.textContent = log;
                resultDiv.className = 'result success';
                
            } catch (error) {
                log += `âŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}`;
                resultDiv.textContent = log;
                resultDiv.className = 'result error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€
        window.onload = function() {
            checkAuthStatus();
        };
    </script>
</body>
</html>