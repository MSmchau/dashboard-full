<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证系统测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #66b1ff;
        }
        .result {
            background: #f0f9ff;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #409eff;
            font-family: monospace;
        }
        .error {
            background: #fef0f0;
            border-left-color: #f56c6c;
            color: #c45656;
        }
    </style>
</head>
<body>
    <h1>认证系统测试页面</h1>
    
    <div class="test-section">
        <h2>1. 认证状态检查</h2>
        <button onclick="checkAuthStatus()">检查认证状态</button>
        <div id="auth-status"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 设备监控页面访问测试</h2>
        <button onclick="testDeviceMonitor()">测试访问 /device-monitor</button>
        <div id="device-monitor-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 登录流程测试</h3>
        <button onclick="testLoginFlow()">测试登录流程</button>
        <div id="login-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 路由守卫测试</h2>
        <button onclick="testRouterGuards()">测试路由守卫</button>
        <div id="router-result"></div>
    </div>
    
    <script>
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML += `<div class="result ${isError ? 'error' : ''}">${message}</div>`;
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        async function checkAuthStatus() {
            clearLog('auth-status');
            
            try {
                // 检查localStorage中的认证信息
                const token = localStorage.getItem('token');
                const userInfo = localStorage.getItem('userInfo');
                
                log('auth-status', `Token存在: ${!!token}`);
                log('auth-status', `Token长度: ${token ? token.length : 0}`);
                
                if (userInfo) {
                    const parsedUser = JSON.parse(userInfo);
                    log('auth-status', `用户信息: ${JSON.stringify(parsedUser, null, 2)}`);
                } else {
                    log('auth-status', '未找到用户信息', true);
                }
                
                // 检查认证服务状态
                log('auth-status', '尝试访问认证服务...');
                const response = await fetch('/api/auth/status');
                log('auth-status', `认证状态响应: ${response.status}`);
                
                if (response.ok) {
                    const status = await response.json();
                    log('auth-status', `认证服务状态: ${JSON.stringify(status, null, 2)}`);
                } else {
                    log('auth-status', `认证服务错误: ${response.status}`, true);
                }
                
            } catch (error) {
                log('auth-status', `检查认证状态失败: ${error.message}`, true);
            }
        }
        
        async function testDeviceMonitor() {
            clearLog('device-monitor-result');
            
            try {
                log('device-monitor-result', '开始测试设备监控页面访问...');
                
                // 尝试直接访问设备监控页面
                const response = await fetch('/device-monitor', {
                    method: 'GET',
                    redirect: 'manual'
                });
                
                log('device-monitor-result', `响应状态: ${response.status}`);
                log('device-monitor-result', `重定向URL: ${response.headers.get('location') || '无'}`);
                
                if (response.status === 302 || response.status === 301) {
                    const redirectUrl = response.headers.get('location');
                    if (redirectUrl && redirectUrl.includes('/login')) {
                        log('device-monitor-result', '✓ 路由守卫正常工作，未认证用户被重定向到登录页');
                    } else {
                        log('device-monitor-result', `✓ 页面重定向到: ${redirectUrl}`);
                    }
                } else if (response.ok) {
                    log('device-monitor-result', '✓ 页面访问成功，可能已认证');
                } else {
                    log('device-monitor-result', `页面访问失败: ${response.status}`, true);
                }
                
            } catch (error) {
                log('device-monitor-result', `设备监控页面测试失败: ${error.message}`, true);
            }
        }
        
        async function testLoginFlow() {
            clearLog('login-result');
            
            try {
                log('login-result', '开始测试登录流程...');
                
                // 模拟登录请求
                const loginData = {
                    username: 'admin',
                    password: 'admin123'
                };
                
                log('login-result', `发送登录请求: ${JSON.stringify(loginData)}`);
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginData)
                });
                
                log('login-result', `登录响应状态: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log('login-result', `✓ 登录成功: ${JSON.stringify(result, null, 2)}`);
                    
                    // 再次检查认证状态
                    setTimeout(() => {
                        checkAuthStatus();
                    }, 1000);
                    
                } else {
                    const error = await response.text();
                    log('login-result', `登录失败: ${response.status} - ${error}`, true);
                }
                
            } catch (error) {
                log('login-result', `登录流程测试失败: ${error.message}`, true);
            }
        }
        
        async function testRouterGuards() {
            clearLog('router-result');
            
            try {
                log('router-result', '开始测试路由守卫...');
                
                // 检查控制台输出
                const originalLog = console.log;
                const logs = [];
                
                console.log = function(...args) {
                    logs.push(args.join(' '));
                    originalLog.apply(console, args);
                };
                
                // 模拟页面访问
                const testUrls = ['/dashboard', '/device-monitor', '/users'];
                
                for (const url of testUrls) {
                    log('router-result', `测试访问: ${url}`);
                    
                    try {
                        const response = await fetch(url, {
                            method: 'GET',
                            redirect: 'manual'
                        });
                        
                        log('router-result', `  响应: ${response.status} -> ${response.headers.get('location') || '直接访问'}`);
                    } catch (error) {
                        log('router-result', `  错误: ${error.message}`, true);
                    }
                }
                
                // 恢复console.log
                console.log = originalLog;
                
                // 检查是否有路由守卫相关的日志
                const guardLogs = logs.filter(log => 
                    log.includes('路由') || 
                    log.includes('认证') || 
                    log.includes('权限') ||
                    log.includes('守卫')
                );
                
                if (guardLogs.length > 0) {
                    log('router-result', '✓ 检测到路由守卫日志:');
                    guardLogs.forEach(log => {
                        log('router-result', `  - ${log}`);
                    });
                } else {
                    log('router-result', '⚠ 未检测到路由守卫日志，可能需要页面刷新', true);
                }
                
            } catch (error) {
                log('router-result', `路由守卫测试失败: ${error.message}`, true);
            }
        }
        
        // 页面加载时自动检查认证状态
        window.onload = function() {
            log('auth-status', '页面已加载，开始检查认证状态...');
            setTimeout(checkAuthStatus, 1000);
        };
    </script>
</body>
</html>