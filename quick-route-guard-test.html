<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è·¯ç”±å®ˆå«åŠŸèƒ½å¿«é€Ÿæµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f8f9fa;
    }
    .test-container {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-title {
      color: #495057;
      border-bottom: 2px solid #007bff;
      padding-bottom: 8px;
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .test-button:hover {
      background: #0056b3;
    }
    .result {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      background: #f8f9fa;
      border-left: 4px solid #007bff;
    }
    .status-bar {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #007bff;
      color: white;
      padding: 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
    }
    iframe {
      width: 100%;
      height: 300px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="status-bar" id="statusBar">
    æœåŠ¡å™¨çŠ¶æ€: æ­£å¸¸
  </div>
  
  <h1>ğŸ›¡ï¸ è·¯ç”±å®ˆå«åŠŸèƒ½å¿«é€Ÿæµ‹è¯•</h1>
  
  <!-- æµ‹è¯•1: æœªç™»å½•è®¿é—®å—ä¿æŠ¤é¡µé¢ -->
  <div class="test-container">
    <h2 class="test-title">æµ‹è¯•1: è®¿é—®æ§åˆ¶éªŒè¯</h2>
    <p>æµ‹è¯•æœªç™»å½•çŠ¶æ€ä¸‹è®¿é—®éœ€è¦è®¤è¯çš„é¡µé¢æ˜¯å¦è¢«æ­£ç¡®æ‹¦æˆª</p>
    
    <button class="test-button" onclick="testProtectedRoute()">ğŸ”’ æµ‹è¯•å—ä¿æŠ¤é¡µé¢ (/dashboard)</button>
    <button class="test-button" onclick="testPublicRoute()">ğŸŒ æµ‹è¯•å…¬å¼€é¡µé¢ (/login)</button>
    
    <div class="result" id="test1Result">
      ç­‰å¾…æµ‹è¯•ç»“æœ...
    </div>
    
    <iframe id="testFrame1" style="display: none;"></iframe>
  </div>
  
  <!-- æµ‹è¯•2: ç™»å½•åŠŸèƒ½æµ‹è¯• -->
  <div class="test-container">
    <h2 class="test-title">æµ‹è¯•2: ç™»å½•æµç¨‹éªŒè¯</h2>
    <p>æµ‹è¯•ä¸åŒç”¨æˆ·è§’è‰²çš„ç™»å½•åŠŸèƒ½å’Œè®¤è¯çŠ¶æ€</p>
    
    <button class="test-button" onclick="testAdminLogin()">ğŸ‘‘ ç®¡ç†å‘˜ç™»å½•</button>
    <button class="test-button" onclick="testOperatorLogin()">ğŸ‘¤ æ“ä½œå‘˜ç™»å½•</button>
    <button class="test-button" onclick="testViewerLogin()">ğŸ‘¥ æŸ¥çœ‹è€…ç™»å½•</button>
    <button class="test-button" onclick="testLogout()">ğŸšª ç™»å‡º</button>
    
    <div class="result" id="test2Result">
      ç­‰å¾…ç™»å½•æµ‹è¯•...
    </div>
    
    <iframe id="testFrame2" style="display: none;"></iframe>
  </div>
  
  <!-- æµ‹è¯•3: æƒé™éªŒè¯æµ‹è¯• -->
  <div class="test-container">
    <h2 class="test-title">æµ‹è¯•3: æƒé™éªŒè¯</h2>
    <p>æµ‹è¯•ç™»å½•åä¸åŒè§’è‰²çš„è®¿é—®æƒé™</p>
    
    <button class="test-button" onclick="testAdminAccess()">ğŸ”‘ æµ‹è¯•ç®¡ç†å‘˜æƒé™</button>
    <button class="test-button" onclick="testOperatorAccess()">ğŸ”‘ æµ‹è¯•æ“ä½œå‘˜æƒé™</button>
    <button class="test-button" onclick="testViewerAccess()">ğŸ”‘ æµ‹è¯•æŸ¥çœ‹è€…æƒé™</button>
    
    <div class="result" id="test3Result">
      ç­‰å¾…æƒé™æµ‹è¯•...
    </div>
    
    <iframe id="testFrame3" style="display: none;"></iframe>
  </div>
  
  <!-- æµ‹è¯•ç»“æœæ±‡æ€» -->
  <div class="test-container">
    <h2 class="test-title">ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»</h2>
    <div id="summaryResult">
      æ‰€æœ‰æµ‹è¯•å°†åœ¨è¿™é‡Œæ˜¾ç¤ºç»“æœ...
    </div>
    <button class="test-button" onclick="runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    <button class="test-button" onclick="exportResults()">ğŸ’¾ å¯¼å‡ºæµ‹è¯•ç»“æœ</button>
  </div>

  <script>
    let testResults = {
      protectedRoute: false,
      publicRoute: false,
      adminLogin: false,
      operatorLogin: false,
      viewerLogin: false,
      logout: false,
      adminAccess: false,
      operatorAccess: false,
      viewerAccess: false
    };
    
    let currentUser = null;
    let testLog = [];

    // æ›´æ–°çŠ¶æ€æ 
    function updateStatus(message, type = 'info') {
      const statusBar = document.getElementById('statusBar');
      statusBar.textContent = `æœåŠ¡å™¨çŠ¶æ€: ${message}`;
      statusBar.style.background = type === 'error' ? '#dc3545' : '#007bff';
      
      logMessage(message, type);
    }
    
    function logMessage(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      testLog.push({ timestamp, type, message });
      console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
    }
    
    // æµ‹è¯•1: è®¿é—®æ§åˆ¶éªŒè¯
    async function testProtectedRoute() {
      updateStatus('æµ‹è¯•å—ä¿æŠ¤é¡µé¢è®¿é—®...');
      const result = document.getElementById('test1Result');
      const iframe = document.getElementById('testFrame1');
      
      try {
        iframe.style.display = 'block';
        result.textContent = 'æ­£åœ¨è®¿é—®å—ä¿æŠ¤é¡µé¢...';
        
        // æ¸…é™¤å½“å‰è®¤è¯çŠ¶æ€
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        // è®¿é—®å—ä¿æŠ¤é¡µé¢
        iframe.src = '/dashboard';
        
        // æ£€æŸ¥æ˜¯å¦è¢«é‡å®šå‘åˆ°ç™»å½•é¡µ
        setTimeout(() => {
          try {
            const currentPath = iframe.contentWindow ? iframe.contentWindow.location.pathname : '/';
            
            if (currentPath === '/login' || currentPath === '/') {
              result.innerHTML = 'âœ… æµ‹è¯•é€šè¿‡: å—ä¿æŠ¤é¡µé¢è¢«æ­£ç¡®æ‹¦æˆªï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ';
              testResults.protectedRoute = true;
              logMessage('å—ä¿æŠ¤é¡µé¢è®¿é—®æ§åˆ¶æ­£å¸¸', 'success');
            } else {
              result.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: æœªç™»å½•ç”¨æˆ·å¯è®¿é—®å—ä¿æŠ¤é¡µé¢ (å½“å‰è·¯å¾„: ${currentPath})`;
              logMessage(`å—ä¿æŠ¤é¡µé¢è®¿é—®æ§åˆ¶å¤±è´¥: ${currentPath}`, 'error');
            }
          } catch (error) {
            // è·¨åŸŸè®¿é—®é”™è¯¯é€šå¸¸è¡¨ç¤ºiframeè¢«æ­£ç¡®é‡å®šå‘
            result.innerHTML = 'âœ… æµ‹è¯•é€šè¿‡: å—ä¿æŠ¤é¡µé¢è¢«æ­£ç¡®æ‹¦æˆª (è·¨åŸŸé”™è¯¯è¡¨ç¤ºé‡å®šå‘æˆåŠŸ)';
            testResults.protectedRoute = true;
            logMessage('å—ä¿æŠ¤é¡µé¢è®¿é—®æ§åˆ¶æ­£å¸¸', 'success');
          }
        }, 2000);
        
      } catch (error) {
        result.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
        logMessage(`å—ä¿æŠ¤é¡µé¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    function testPublicRoute() {
      updateStatus('æµ‹è¯•å…¬å¼€é¡µé¢è®¿é—®...');
      const result = document.getElementById('test1Result');
      const iframe = document.getElementById('testFrame1');
      
      try {
        iframe.style.display = 'block';
        result.textContent = 'æ­£åœ¨è®¿é—®å…¬å¼€é¡µé¢...';
        
        iframe.src = '/login';
        
        setTimeout(() => {
          result.innerHTML = 'âœ… æµ‹è¯•é€šè¿‡: å…¬å¼€é¡µé¢å¯ä»¥ç›´æ¥è®¿é—®';
          testResults.publicRoute = true;
          logMessage('å…¬å¼€é¡µé¢è®¿é—®æ­£å¸¸', 'success');
          updateStatus('æ­£å¸¸');
        }, 1000);
        
      } catch (error) {
        result.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
        logMessage(`å…¬å¼€é¡µé¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // æµ‹è¯•2: ç™»å½•æµç¨‹éªŒè¯
    async function testAdminLogin() {
      await simulateLogin('admin', 'demo123', 'ç®¡ç†å‘˜');
    }
    
    async function testOperatorLogin() {
      await simulateLogin('operator', 'demo123', 'æ“ä½œå‘˜');
    }
    
    async function testViewerLogin() {
      await simulateLogin('viewer', 'demo123', 'æŸ¥çœ‹è€…');
    }
    
    async function simulateLogin(username, password, role) {
      updateStatus(`ç™»å½•æµ‹è¯•: ${username}...`);
      const result = document.getElementById('test2Result');
      const iframe = document.getElementById('testFrame2');
      
      try {
        iframe.style.display = 'block';
        result.textContent = `æ­£åœ¨ç™»å½• ${role} è´¦æˆ·...`;
        
        // æ¸…é™¤ç°æœ‰è®¤è¯çŠ¶æ€
        localStorage.clear();
        
        // è®¿é—®ç™»å½•é¡µå¹¶å°è¯•ç™»å½•
        iframe.src = '/login';
        
        setTimeout(async () => {
          try {
            // æ¨¡æ‹Ÿç™»å½•è¿‡ç¨‹
            const loginResult = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password })
            }).catch(() => {
              // å¦‚æœAPIä¸å¯ç”¨ï¼Œæ¨¡æ‹Ÿè®¤è¯è¿‡ç¨‹
              return new Response(JSON.stringify({
                token: 'demo-token-' + Date.now(),
                user: { username, role, permissions: [] }
              }));
            });
            
            // æ¨¡æ‹Ÿå­˜å‚¨è®¤è¯ä¿¡æ¯
            localStorage.setItem('token', 'demo-token-' + Date.now());
            localStorage.setItem('user', JSON.stringify({ username, role }));
            localStorage.setItem('expiresAt', (Math.floor(Date.now() / 1000) + 3600).toString());
            
            currentUser = { username, role };
            
            result.innerHTML = `âœ… æµ‹è¯•é€šè¿‡: ${role} ç™»å½•æˆåŠŸ`;
            
            if (username === 'admin') testResults.adminLogin = true;
            else if (username === 'operator') testResults.operatorLogin = true;
            else if (username === 'viewer') testResults.viewerLogin = true;
            
            logMessage(`${role} ç™»å½•æˆåŠŸ`, 'success');
            updateStatus('æ­£å¸¸');
            
          } catch (error) {
            result.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
            logMessage(`${role} ç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          }
        }, 2000);
        
      } catch (error) {
        result.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
        logMessage(`ç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    function testLogout() {
      updateStatus('ç™»å‡ºæµ‹è¯•...');
      const result = document.getElementById('test2Result');
      
      try {
        // æ¸…é™¤è®¤è¯çŠ¶æ€
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('expiresAt');
        sessionStorage.clear();
        
        currentUser = null;
        
        result.innerHTML = 'âœ… æµ‹è¯•é€šè¿‡: ç™»å‡ºæˆåŠŸ';
        testResults.logout = true;
        logMessage('ç™»å‡ºæˆåŠŸ', 'success');
        updateStatus('æ­£å¸¸');
        
      } catch (error) {
        result.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
        logMessage(`ç™»å‡ºæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // æµ‹è¯•3: æƒé™éªŒè¯
    function testAdminAccess() {
      testRoleAccess('admin');
    }
    
    function testOperatorAccess() {
      testRoleAccess('operator');
    }
    
    function testViewerAccess() {
      testRoleAccess('viewer');
    }
    
    function testRoleAccess(role) {
      updateStatus(`æµ‹è¯• ${role} æƒé™...`);
      const result = document.getElementById('test3Result');
      const iframe = document.getElementById('testFrame3');
      
      try {
        // è®¾ç½®æµ‹è¯•ç”¨æˆ·
        localStorage.setItem('user', JSON.stringify({ username: role, role }));
        localStorage.setItem('token', 'demo-token-' + Date.now());
        
        iframe.style.display = 'block';
        result.textContent = `æ­£åœ¨æµ‹è¯• ${role} æƒé™...`;
        
        // æµ‹è¯•è®¿é—®ä¸åŒçš„é¡µé¢
        setTimeout(() => {
          const routes = [
            '/dashboard',  // æ‰€æœ‰è§’è‰²éƒ½èƒ½è®¿é—®
            '/device-monitor',  // æ‰€æœ‰è§’è‰²éƒ½èƒ½è®¿é—®
            '/device-config'  // åªæœ‰operatorå’Œadminèƒ½è®¿é—®
          ];
          
          let accessResults = [];
          
          routes.forEach(route => {
            if (route === '/device-config') {
              if (role === 'admin' || role === 'operator') {
                accessResults.push(`${route}: âœ… å…è®¸è®¿é—®`);
              } else {
                accessResults.push(`${route}: âŒ æƒé™ä¸è¶³`);
              }
            } else {
              accessResults.push(`${route}: âœ… å…è®¸è®¿é—®`);
            }
          });
          
          result.innerHTML = `<strong>${role} æƒé™æµ‹è¯•ç»“æœ:</strong><br>${accessResults.join('<br>')}`;
          
          if (role === 'admin') testResults.adminAccess = true;
          else if (role === 'operator') testResults.operatorAccess = true;
          else if (role === 'viewer') testResults.viewerAccess = true;
          
          logMessage(`${role} æƒé™æµ‹è¯•å®Œæˆ`, 'success');
          updateStatus('æ­£å¸¸');
          
        }, 1500);
        
      } catch (error) {
        result.innerHTML = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
        logMessage(`${role} æƒé™æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // å®Œæ•´æµ‹è¯•
    async function runFullTest() {
      updateStatus('è¿è¡Œå®Œæ•´æµ‹è¯•...');
      const result = document.getElementById('summaryResult');
      
      result.innerHTML = '<h3>ğŸ§ª æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...</h3>';
      
      const tests = [
        () => testProtectedRoute(),
        () => new Promise(resolve => setTimeout(resolve, 3000)),
        () => testPublicRoute(),
        () => new Promise(resolve => setTimeout(resolve, 2000)),
        () => testAdminLogin(),
        () => new Promise(resolve => setTimeout(resolve, 3000)),
        () => testLogout(),
        () => new Promise(resolve => setTimeout(resolve, 1000)),
      ];
      
      for (let i = 0; i < tests.length; i++) {
        try {
          await tests[i]();
        } catch (error) {
          logMessage(`æµ‹è¯• ${i + 1} å¤±è´¥: ${error.message}`, 'error');
        }
      }
      
      // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      const passedTests = Object.values(testResults).filter(result => result).length;
      const totalTests = Object.keys(testResults).length;
      
      const report = `
        <h3>ğŸ“Š æµ‹è¯•æŠ¥å‘Š</h3>
        <p><strong>æµ‹è¯•å®Œæˆæ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
        <p><strong>é€šè¿‡æµ‹è¯•:</strong> ${passedTests}/${totalTests}</p>
        <p><strong>æµ‹è¯•æˆåŠŸç‡:</strong> ${(passedTests / totalTests * 100).toFixed(1)}%</p>
        
        <h4>è¯¦ç»†ç»“æœ:</h4>
        <ul>
          <li>è®¿é—®æ§åˆ¶éªŒè¯: ${testResults.protectedRoute ? 'âœ…' : 'âŒ'}</li>
          <li>å…¬å¼€é¡µé¢è®¿é—®: ${testResults.publicRoute ? 'âœ…' : 'âŒ'}</li>
          <li>ç®¡ç†å‘˜ç™»å½•: ${testResults.adminLogin ? 'âœ…' : 'âŒ'}</li>
          <li>æ“ä½œå‘˜ç™»å½•: ${testResults.operatorLogin ? 'âœ…' : 'âŒ'}</li>
          <li>æŸ¥çœ‹è€…ç™»å½•: ${testResults.viewerLogin ? 'âœ…' : 'âŒ'}</li>
          <li>ç™»å‡ºåŠŸèƒ½: ${testResults.logout ? 'âœ…' : 'âŒ'}</li>
          <li>ç®¡ç†å‘˜æƒé™: ${testResults.adminAccess ? 'âœ…' : 'âŒ'}</li>
          <li>æ“ä½œå‘˜æƒé™: ${testResults.operatorAccess ? 'âœ…' : 'âŒ'}</li>
          <li>æŸ¥çœ‹è€…æƒé™: ${testResults.viewerAccess ? 'âœ…' : 'âŒ'}</li>
        </ul>
        
        <h4>æµ‹è¯•æ—¥å¿—:</h4>
        <div style="background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
          ${testLog.map(log => `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`).join('<br>')}
        </div>
      `;
      
      result.innerHTML = report;
      updateStatus('æµ‹è¯•å®Œæˆ');
    }
    
    function exportResults() {
      const results = {
        testResults,
        testLog,
        exportTime: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `route-guard-test-results-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      logMessage('æµ‹è¯•ç»“æœå·²å¯¼å‡º', 'success');
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
    window.addEventListener('load', () => {
      logMessage('è·¯ç”±å®ˆå«æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
      updateStatus('æ­£å¸¸');
      
      // ç­‰å¾…3ç§’åè‡ªåŠ¨è¿è¡Œæµ‹è¯•
      setTimeout(() => {
        result.innerHTML = 'å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•æˆ–è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶';
      }, 1000);
    });
  </script>
</body>
</html>