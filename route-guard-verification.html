<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è·¯ç”±å®ˆå«åŠŸèƒ½éªŒè¯</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      margin: 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .log-entry {
      margin: 2px 0;
      padding: 2px 4px;
      border-left: 3px solid transparent;
    }
    .log-entry.info { border-left-color: #17a2b8; }
    .log-entry.success { border-left-color: #28a745; }
    .log-entry.warning { border-left-color: #ffc107; }
    .log-entry.error { border-left-color: #dc3545; }
    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>ğŸ›¡ï¸ è·¯ç”±å®ˆå«åŠŸèƒ½éªŒè¯</h1>
  
  <!-- çŠ¶æ€ç›‘æ§ -->
  <div class="test-section">
    <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€ç›‘æ§</h2>
    <div id="authStatus" class="status info">æ£€æŸ¥ä¸­...</div>
    <div id="routerStatus" class="status info">æ£€æŸ¥ä¸­...</div>
    <div id="permissionStatus" class="status info">æ£€æŸ¥ä¸­...</div>
    
    <button onclick="checkSystemStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
  </div>
  
  <!-- è®¤è¯æµ‹è¯• -->
  <div class="test-section">
    <h2>ğŸ” è®¤è¯æµç¨‹æµ‹è¯•</h2>
    <p>æµ‹è¯•ç™»å½•ã€ç™»å‡ºå’Œè®¤è¯çŠ¶æ€ç®¡ç†åŠŸèƒ½</p>
    
    <div>
      <button onclick="testLogin('admin', 'demo123')">ğŸ‘¤ ç™»å½•ç®¡ç†å‘˜</button>
      <button onclick="testLogin('operator', 'demo123')">ğŸ‘¤ ç™»å½•æ“ä½œå‘˜</button>
      <button onclick="testLogin('viewer', 'demo123')">ğŸ‘¤ ç™»å½•æŸ¥çœ‹è€…</button>
      <button onclick="testLogout()">ğŸšª ç™»å‡º</button>
    </div>
    
    <div id="loginResult" class="status info" style="margin-top: 10px;">ç­‰å¾…æµ‹è¯•...</div>
  </div>
  
  <!-- æƒé™æµ‹è¯• -->
  <div class="test-section">
    <h2>ğŸ›¡ï¸ æƒé™éªŒè¯æµ‹è¯•</h2>
    <p>æµ‹è¯•ç”¨æˆ·è§’è‰²å’Œæƒé™æ£€æŸ¥åŠŸèƒ½</p>
    
    <button onclick="testPermissions()">ğŸ” æ£€æŸ¥æ‰€æœ‰æƒé™</button>
    <button onclick="testRoles()">ğŸ‘¥ æ£€æŸ¥ç”¨æˆ·è§’è‰²</button>
    
    <div id="permissionResult" class="status info" style="margin-top: 10px;">ç­‰å¾…æµ‹è¯•...</div>
  </div>
  
  <!-- è·¯ç”±æµ‹è¯• -->
  <div class="test-section">
    <h2>ğŸ›£ï¸ è·¯ç”±å¯¼èˆªæµ‹è¯•</h2>
    <p>æµ‹è¯•è·¯ç”±å®ˆå«çš„æ‹¦æˆªå’Œæ”¾è¡ŒåŠŸèƒ½</p>
    
    <div>
      <button onclick="testPublicRoute()">ğŸŒ æµ‹è¯•å…¬å¼€è·¯ç”±</button>
      <button onclick="testProtectedRoute()">ğŸ”’ æµ‹è¯•å—ä¿æŠ¤è·¯ç”±</button>
      <button onclick="testAdminRoute()">ğŸ‘‘ æµ‹è¯•ç®¡ç†å‘˜è·¯ç”±</button>
    </div>
    
    <div class="two-column" style="margin-top: 10px;">
      <div>
        <h4>æµ‹è¯•ç»“æœ</h4>
        <div id="routeResult" class="status info">ç­‰å¾…æµ‹è¯•...</div>
      </div>
      <div>
        <h4>æµè§ˆå™¨é¢„è§ˆ</h4>
        <iframe id="testFrame" src="about:blank"></iframe>
      </div>
    </div>
  </div>
  
  <!-- æ—¥å¿—ç›‘æ§ -->
  <div class="test-section">
    <h2>ğŸ“ å®æ—¶æ—¥å¿—ç›‘æ§</h2>
    <p>å®æ—¶æ˜¾ç¤ºè·¯ç”±å®ˆå«çš„è¿è¡Œæ—¥å¿—</p>
    
    <div>
      <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
      <button onclick="exportLogs()">ğŸ’¾ å¯¼å‡ºæ—¥å¿—</button>
    </div>
    
    <div id="logContainer" class="log-container">
      <div class="log-entry info">[ç­‰å¾…] ç³»ç»Ÿå·²å¯åŠ¨ï¼Œç­‰å¾…æµ‹è¯•...</div>
    </div>
  </div>

  <script>
    // æ—¥å¿—ç³»ç»Ÿ
    const logs = [];
    
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, type, message };
      logs.push(logEntry);
      
      const logContainer = document.getElementById('logContainer');
      const logDiv = document.createElement('div');
      logDiv.className = `log-entry ${type}`;
      logDiv.textContent = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
      
      logContainer.appendChild(logDiv);
      logContainer.scrollTop = logContainer.scrollHeight;
      
      console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
    }
    
    function clearLogs() {
      logs.length = 0;
      document.getElementById('logContainer').innerHTML = '';
      addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
    }
    
    function exportLogs() {
      const logText = logs.map(log => `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`).join('\n');
      const blob = new Blob([logText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `route-guard-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      addLog('æ—¥å¿—å·²å¯¼å‡º', 'success');
    }
    
    // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
    async function checkSystemStatus() {
      addLog('å¼€å§‹æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...', 'info');
      
      try {
        // æ£€æŸ¥è®¤è¯æœåŠ¡
        const authStatus = document.getElementById('authStatus');
        if (window.authService) {
          const isLoggedIn = window.authService.isLoggedIn();
          authStatus.className = `status ${isLoggedIn ? 'success' : 'warning'}`;
          authStatus.textContent = `è®¤è¯æœåŠ¡: ${isLoggedIn ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`;
          
          if (isLoggedIn) {
            const user = window.authService.currentUser;
            authStatus.textContent += ` (ç”¨æˆ·: ${user?.username || 'æœªçŸ¥'})`;
          }
        } else {
          authStatus.className = 'status error';
          authStatus.textContent = 'è®¤è¯æœåŠ¡: æœªæ‰¾åˆ°';
        }
        
        // æ£€æŸ¥è·¯ç”±æœåŠ¡
        const routerStatus = document.getElementById('routerStatus');
        if (window.router) {
          const currentRoute = window.router.currentRoute.value;
          routerStatus.className = 'status success';
          routerStatus.textContent = `è·¯ç”±æœåŠ¡: æ­£å¸¸ (å½“å‰: ${currentRoute?.path || 'æœªçŸ¥'})`;
        } else {
          routerStatus.className = 'status error';
          routerStatus.textContent = 'è·¯ç”±æœåŠ¡: æœªæ‰¾åˆ°';
        }
        
        // æ£€æŸ¥æƒé™ç³»ç»Ÿ
        const permissionStatus = document.getElementById('permissionStatus');
        if (window.PERMISSIONS && window.ROLES) {
          permissionStatus.className = 'status success';
          permissionStatus.textContent = 'æƒé™ç³»ç»Ÿ: å·²åŠ è½½';
        } else {
          permissionStatus.className = 'status error';
          permissionStatus.textContent = 'æƒé™ç³»ç»Ÿ: æœªæ‰¾åˆ°';
        }
        
        addLog('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
        
      } catch (error) {
        addLog(`ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // è®¤è¯æµ‹è¯•
    async function testLogin(username, password) {
      addLog(`å°è¯•ç™»å½•ç”¨æˆ·: ${username}`, 'info');
      
      const loginResult = document.getElementById('loginResult');
      loginResult.className = 'status info';
      loginResult.textContent = 'æ­£åœ¨ç™»å½•...';
      
      try {
        if (!window.authService) {
          throw new Error('è®¤è¯æœåŠ¡æœªæ‰¾åˆ°');
        }
        
        const user = await window.authService.login(username, password, false);
        loginResult.className = 'status success';
        loginResult.textContent = `ç™»å½•æˆåŠŸ: ${user.username} (${user.role})`;
        addLog(`ç”¨æˆ· ${user.username} ç™»å½•æˆåŠŸ`, 'success');
        
        // åˆ·æ–°çŠ¶æ€
        await checkSystemStatus();
        
      } catch (error) {
        loginResult.className = 'status error';
        loginResult.textContent = `ç™»å½•å¤±è´¥: ${error.message}`;
        addLog(`ç™»å½•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    async function testLogout() {
      addLog('å¼€å§‹ç™»å‡º...', 'info');
      
      const loginResult = document.getElementById('loginResult');
      
      try {
        if (window.authService) {
          await window.authService.logout();
          loginResult.className = 'status warning';
          loginResult.textContent = 'å·²ç™»å‡º';
          addLog('ç”¨æˆ·å·²ç™»å‡º', 'success');
          
          // åˆ·æ–°çŠ¶æ€
          await checkSystemStatus();
        } else {
          throw new Error('è®¤è¯æœåŠ¡æœªæ‰¾åˆ°');
        }
      } catch (error) {
        loginResult.className = 'status error';
        loginResult.textContent = `ç™»å‡ºå¤±è´¥: ${error.message}`;
        addLog(`ç™»å‡ºå¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // æƒé™æµ‹è¯•
    function testPermissions() {
      addLog('å¼€å§‹æƒé™æ£€æŸ¥...', 'info');
      
      const permissionResult = document.getElementById('permissionResult');
      permissionResult.className = 'status info';
      
      try {
        if (!window.authService) {
          throw new Error('è®¤è¯æœåŠ¡æœªæ‰¾åˆ°');
        }
        
        const permissions = [
          'dashboard:view',
          'device:view',
          'device:manage',
          'error:view',
          'performance:view'
        ];
        
        const results = permissions.map(perm => {
          const has = window.authService.hasPermission(perm);
          return `${perm}: ${has ? 'âœ“' : 'âœ—'}`;
        });
        
        permissionResult.className = 'status success';
        permissionResult.innerHTML = results.join('<br>');
        addLog('æƒé™æ£€æŸ¥å®Œæˆ', 'success');
        
      } catch (error) {
        permissionResult.className = 'status error';
        permissionResult.textContent = `æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`;
        addLog(`æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    function testRoles() {
      addLog('å¼€å§‹è§’è‰²æ£€æŸ¥...', 'info');
      
      const permissionResult = document.getElementById('permissionResult');
      
      try {
        if (!window.authService) {
          throw new Error('è®¤è¯æœåŠ¡æœªæ‰¾åˆ°');
        }
        
        const roles = ['admin', 'operator', 'viewer'];
        const results = roles.map(role => {
          const has = window.authService.hasRole(role);
          return `${role}: ${has ? 'âœ“' : 'âœ—'}`;
        });
        
        permissionResult.className = 'status success';
        permissionResult.innerHTML = results.join('<br>');
        addLog('è§’è‰²æ£€æŸ¥å®Œæˆ', 'success');
        
      } catch (error) {
        permissionResult.className = 'status error';
        permissionResult.textContent = `è§’è‰²æ£€æŸ¥å¤±è´¥: ${error.message}`;
        addLog(`è§’è‰²æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // è·¯ç”±æµ‹è¯•
    async function testPublicRoute() {
      addLog('æµ‹è¯•å…¬å¼€è·¯ç”±è®¿é—®...', 'info');
      
      const routeResult = document.getElementById('routeResult');
      const frame = document.getElementById('testFrame');
      
      try {
        routeResult.className = 'status info';
        routeResult.textContent = 'æ­£åœ¨æµ‹è¯•å…¬å¼€è·¯ç”±...';
        
        // æµ‹è¯•è®¿é—®å…¬å¼€è·¯ç”±
        frame.src = '/router-test';
        
        setTimeout(() => {
          routeResult.className = 'status success';
          routeResult.textContent = 'âœ“ å…¬å¼€è·¯ç”±è®¿é—®æˆåŠŸ';
          addLog('å…¬å¼€è·¯ç”±è®¿é—®æˆåŠŸ', 'success');
        }, 1000);
        
      } catch (error) {
        routeResult.className = 'status error';
        routeResult.textContent = `å…¬å¼€è·¯ç”±æµ‹è¯•å¤±è´¥: ${error.message}`;
        addLog(`å…¬å¼€è·¯ç”±æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    async function testProtectedRoute() {
      addLog('æµ‹è¯•å—ä¿æŠ¤è·¯ç”±è®¿é—®...', 'info');
      
      const routeResult = document.getElementById('routeResult');
      const frame = document.getElementById('testFrame');
      
      try {
        routeResult.className = 'status info';
        routeResult.textContent = 'æ­£åœ¨æµ‹è¯•å—ä¿æŠ¤è·¯ç”±...';
        
        // æµ‹è¯•è®¿é—®å—ä¿æŠ¤è·¯ç”±
        frame.src = '/dashboard';
        
        setTimeout(() => {
          // æ£€æŸ¥æ˜¯å¦è¢«é‡å®šå‘åˆ°ç™»å½•é¡µ
          if (frame.contentWindow && frame.contentWindow.location.pathname === '/login') {
            routeResult.className = 'status success';
            routeResult.textContent = 'âœ“ å—ä¿æŠ¤è·¯ç”±è¢«æ­£ç¡®æ‹¦æˆªå¹¶é‡å®šå‘';
            addLog('å—ä¿æŠ¤è·¯ç”±è¢«æ­£ç¡®æ‹¦æˆª', 'success');
          } else {
            routeResult.className = 'status warning';
            routeResult.textContent = 'âš  å—ä¿æŠ¤è·¯ç”±æœªè¢«æ‹¦æˆªï¼ˆå¯èƒ½å·²ç™»å½•ï¼‰';
            addLog('å—ä¿æŠ¤è·¯ç”±æœªè¢«æ‹¦æˆª', 'warning');
          }
        }, 2000);
        
      } catch (error) {
        routeResult.className = 'status error';
        routeResult.textContent = `å—ä¿æŠ¤è·¯ç”±æµ‹è¯•å¤±è´¥: ${error.message}`;
        addLog(`å—ä¿æŠ¤è·¯ç”±æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    async function testAdminRoute() {
      addLog('æµ‹è¯•ç®¡ç†å‘˜è·¯ç”±è®¿é—®...', 'info');
      
      const routeResult = document.getElementById('routeResult');
      const frame = document.getElementById('testFrame');
      
      try {
        routeResult.className = 'status info';
        routeResult.textContent = 'æ­£åœ¨æµ‹è¯•ç®¡ç†å‘˜è·¯ç”±...';
        
        // å…ˆç¡®ä¿ç™»å½•ä¸ºç®¡ç†å‘˜
        if (window.authService && !window.authService.isLoggedIn()) {
          await window.authService.login('admin', 'demo123', false);
        }
        
        // æµ‹è¯•è®¿é—®å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™çš„è·¯ç”±
        frame.src = '/device-config';
        
        setTimeout(() => {
          const currentPath = frame.contentWindow ? frame.contentWindow.location.pathname : 'æœªçŸ¥';
          routeResult.className = 'status success';
          routeResult.textContent = `âœ“ ç®¡ç†å‘˜è·¯ç”±æµ‹è¯•: ${currentPath}`;
          addLog(`ç®¡ç†å‘˜è·¯ç”±æµ‹è¯•å®Œæˆ: ${currentPath}`, 'success');
        }, 2000);
        
      } catch (error) {
        routeResult.className = 'status error';
        routeResult.textContent = `ç®¡ç†å‘˜è·¯ç”±æµ‹è¯•å¤±è´¥: ${error.message}`;
        addLog(`ç®¡ç†å‘˜è·¯ç”±æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      addLog('è·¯ç”±å®ˆå«éªŒè¯é¡µé¢å·²åŠ è½½', 'info');
      
      // å®šæœŸåˆ·æ–°çŠ¶æ€
      setInterval(checkSystemStatus, 5000);
      
      // åˆå§‹çŠ¶æ€æ£€æŸ¥
      setTimeout(checkSystemStatus, 1000);
    });
    
    // æš´éœ²å‡½æ•°åˆ°å…¨å±€
    window.checkSystemStatus = checkSystemStatus;
    window.testLogin = testLogin;
    window.testLogout = testLogout;
    window.testPermissions = testPermissions;
    window.testRoles = testRoles;
    window.testPublicRoute = testPublicRoute;
    window.testProtectedRoute = testProtectedRoute;
    window.testAdminRoute = testAdminRoute;
    window.clearLogs = clearLogs;
    window.exportLogs = exportLogs;
  </script>
</body>
</html>